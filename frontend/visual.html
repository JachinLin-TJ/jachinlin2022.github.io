<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <title>jachinLin's Proflie</title>
</head>

<body
  style="background: url(./img/bg.jp);background-size: cover;background-repeat:no-repeat;background-attachment: fixed;">
  <div id="head">
    <nav class="navbar navbar-expand-sm navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#">Visualization</a>
        <ul class="navbar-nav	me-auto ">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="http://192.168.137.128:16010/master-status">数据库状态</a>
          </li>
          <li class="nav-item">
						<a class="nav-link" aria-current="page" href="http://192.168.137.128:9870/dfshealth.html#tab-overview">集群状态</a>
					</li>
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="./table.html">行情中心</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="./visual.html">爬虫可视化</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="./search.html">文章搜索</a>
          </li>
        </ul>
      </div>
    </nav>

  </div>
  <div class="bd">

  </div>
  <div id="content">
    <div class="container">
      <table class="table" id="redis">
        <br>
        <h3>Redis队列</h3>
        <thead>
          <tr>
            <th scope="col">redis server</th>
            <th scope="col">端口</th>
            <th scope="col">待爬取队列</th>
            <th scope="col">已爬取队列</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">192.168.137.128</th>
            <td>6379</td>
            <td id="start_url"></td>
            <td id="crawl_url"></td>
          </tr>
        </tbody>
      </table>

      <table class="table" id="linkSpider">
        <br>
        <h3>linkSpider</h3>
        <thead>
          <tr>
            <th scope="col">所在服务器</th>
            <th scope="col">状态</th>
            <th scope="col">控制</th>
            <th scope="col">编辑</th>
            <th scope="col">保存</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">192.168.1.102</th>
            <td>停止</td>
            <td><button class="start btn btn-primary btn-sm">启动</button></td>
            <td><button class="btn btn-primary btn-sm editLink" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample"
              aria-expanded="false" aria-controls="collapseExample">
              编辑脚本
            </button></td>
            <td><button class="saveLink btn btn-primary btn-sm">保存脚本</button></td>
          </tr>
          <tr>
            <th scope="row">192.168.137.128</th>
            <td>停止</td>
            <td><button class="start btn btn-primary btn-sm">启动</button></td>
            <td><button class="btn btn-primary btn-sm editLink" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample"
              aria-expanded="false" aria-controls="collapseExample">
              编辑脚本
            </button></td>
            <td><button class="saveLink btn btn-primary btn-sm">保存脚本</button></td>
          </tr>
          <tr>
            <th scope="row">192.168.137.129</th>
            <td>停止</td>
            <td><button class="start btn btn-primary btn-sm">启动</button></td>
            <td><button class="btn btn-primary btn-sm editLink" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample"
              aria-expanded="false" aria-controls="collapseExample">
              编辑脚本
            </button></td>
            <td><button class="saveLink btn btn-primary btn-sm">保存脚本</button></td>
          </tr>
        </tbody>
      </table>

      <div class="collapse" id="collapseExample">
        <textarea id="linkSpiderScript" class="form-control" aria-label="With textarea" style="height: 300px;"></textarea>
      </div>

      <table class="table" id="newsSpider">
        <br>
        <h3>newsSpider</h3>
        <thead>
          <tr>
            <th scope="col">所在服务器</th>
            <th scope="col">状态</th>
            <th scope="col">控制</th>
            <th scope="col">控制</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">192.168.1.102</th>
            <td>停止</td>
            <td><button class="start btn btn-primary btn-sm">启动</button></td>
            <td><button>停止</button></td>
          </tr>
          <tr>
            <th scope="row">192.168.137.128</th>
            <td>停止</td>
            <td><button class="start btn btn-primary btn-sm">启动</button></td>
            <td><button>停止</button></td>
          </tr>
          <tr>
            <th scope="row">192.168.137.129</th>
            <td>停止</td>
            <td><button class="start btn btn-primary btn-sm">启动</button></td>
            <td><button>停止</button></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="footer">

  </div>

  <script>
    const crawl = document.querySelector("#crawl_url");
    const start = document.querySelector("#start_url");
    const linkSpiderScript = document.querySelector("#linkSpiderScript");
    function save_link_spider(server) {
      $.post(`http://${server}:5000/save_link_spider`,
        {
          content : linkSpiderScript.value
        },
        function (data, status) {
          if (data) {
            alert(data);
          };
        });
    }
    function get_link_spider(server) {
      $.post(`http://${server}:5000/get_link_spider`,
        {
        },
        function (data, status) {
          if (data) {
            linkSpiderScript.innerHTML = data;
          };
        });
    }
    function update_redis_info() {
      $.post("http://127.0.0.1:5000/get_redis_info",
        {
        },
        function (data, status) {
          crawl.innerHTML = data.crawl_size;
          start.innerHTML = data.start_size;
        });
    };

    function run_link_spider(server, statusNode) {
      $.post(`http://${server}:5000/run_link_spider`,
        {
        },
        function (data, status) {
          if (data === 'ok') {
            statusNode.innerHTML = '停止';
          }
        });
    };

    update_redis_info();
    setInterval(() => {
      update_redis_info();
    }, 5000);

    const start_buttons = document.getElementsByClassName('start');
    for (let i = 0; i < start_buttons.length; ++i) {
      start_buttons[i].onclick = () => {
        const status = start_buttons[i].parentElement.previousElementSibling;
        const server = status.previousElementSibling;
        console.log(server.innerHTML);
        status.innerHTML = '运行';
        // alert('启动');
        run_link_spider(server.innerHTML, status);
      };
    }

    const editLinkButtons = document.getElementsByClassName('editLink');
    for (let i = 0; i < editLinkButtons.length; ++i) {
      editLinkButtons[i].onclick = () => {
        linkSpiderScript.innerHTML = ''
        const status = start_buttons[i].parentElement.previousElementSibling;
        const server = status.previousElementSibling;
        console.log(server.innerHTML);
        // status.innerHTML = '运行';
        get_link_spider(server.innerHTML);
        // alert('启动');
      };
    }

    const saveLinkButtons = document.getElementsByClassName('saveLink');
    for (let i = 0; i < saveLinkButtons.length; ++i) {
      saveLinkButtons[i].onclick = () => {
        const status = start_buttons[i].parentElement.previousElementSibling;
        const server = status.previousElementSibling;
        // console.log(linkSpiderScript.innerHTML);
        // status.innerHTML = '运行';
        console.log(linkSpiderScript.value);
        save_link_spider(server.innerHTML);
        // alert('启动');
      };
    }




  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
</body>

</html>